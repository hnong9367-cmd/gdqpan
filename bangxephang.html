<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Xếp Hạng - Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; }
        .crown-svg { width: 32px; height: 32px; position: absolute; top: -16px; left: 50%; transform: translateX(-50%); filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        .podium-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .podium-card:hover { transform: translateY(-8px); box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
    </style>
</head>
<body>
    <div class="max-w-3xl mx-auto my-8 p-4 md:p-8 bg-white rounded-2xl shadow-lg">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">Bảng Xếp Hạng</h1>
            <p id="status" class="text-gray-500 mt-2">Đang kết nối tới Firebase...</p>
        </div>
        <div class="flex justify-center items-end gap-4 md:gap-6 mb-10 px-4 min-h-[208px]">
            <div id="rank-2-podium" class="w-1/3 text-center"></div>
            <div id="rank-1-podium" class="w-1/3 text-center"></div>
            <div id="rank-3-podium" class="w-1/3 text-center"></div>
        </div>
        <div id="leaderboard-list" class="space-y-3"></div>
        <div id="your-rank-container" class="mt-8 pt-4 border-t-2 border-gray-200"></div>
    </div>

    <script type="module">
        // Import các hàm cần thiết từ Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, onValue, query, orderByChild } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        // Cấu hình Firebase của bạn
        const firebaseConfig = {
            apiKey: "AIzaSyAnt9ctszFdlVIwdX9KDS4hpvyfglclJQ0",
            authDomain: "quizzz-de3f6.firebaseapp.com",
            projectId: "quizzz-de3f6",
            storageBucket: "quizzz-de3f6.appspot.com",
            messagingSenderId: "775849270363",
            appId: "1:775849270363:web:f2871cab3227d93f88737e",
            databaseURL: "https://quizzz-de3f6-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        // Khởi tạo Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Lấy các element DOM
        const [statusEl, rank1Podium, rank2Podium, rank3Podium, leaderboardList, yourRankContainer] = [ 
            document.getElementById('status'), 
            document.getElementById('rank-1-podium'), 
            document.getElementById('rank-2-podium'), 
            document.getElementById('rank-3-podium'), 
            document.getElementById('leaderboard-list'), 
            document.getElementById('your-rank-container') 
        ];

        function createAvatar(name, sizeClass="w-12 h-12", textClass="text-xl") { 
            const initial = name ? name.charAt(0).toUpperCase() : '?'; 
            const colors = ['bg-blue-500', 'bg-green-500', 'bg-red-500', 'bg-purple-500', 'bg-yellow-500', 'bg-indigo-500']; 
            const color = colors[initial.charCodeAt(0) % colors.length]; 
            return `<div class="${sizeClass} ${color} rounded-full flex items-center justify-center text-white font-bold ${textClass}">${initial}</div>`; 
        }

        function listenToLeaderboard() {
            statusEl.textContent = 'Đang tải dữ liệu mới nhất...';
            const leaderboardRef = ref(db, 'leaderboard');
            
            // Lắng nghe sự thay đổi dữ liệu theo thời gian thực
            onValue(leaderboardRef, (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const playersArray = Object.values(data);

                    // Sắp xếp dữ liệu theo quy tắc v7.0
                    playersArray.sort((a, b) => {
                        // Ưu tiên #1: Sắp xếp theo RankingScore giảm dần
                        if (b.rankingScore !== a.rankingScore) {
                            return b.rankingScore - a.rankingScore;
                        }
                        // Ưu tiên #2: Nếu RankingScore bằng nhau, sắp xếp theo ngày nộp mới nhất
                        return b.submissionTimestamp - a.submissionTimestamp;
                    });

                    const currentPlayerID = localStorage.getItem('quizAppPlayerID') || "Bạn không tồn tại";
                    displayLeaderboard(playersArray, currentPlayerID);
                    statusEl.textContent = `Cập nhật theo thời gian thực. Lần cuối: ${new Date().toLocaleTimeString('vi-VN')}`;
                } else {
                    statusEl.textContent = 'Chưa có ai trên bảng xếp hạng. Hãy là người đầu tiên!';
                    clearDisplay();
                }
            }, (error) => {
                console.error("Lỗi khi đọc dữ liệu Firebase:", error);
                statusEl.textContent = `Không thể tải bảng xếp hạng. Lỗi: ${error.message}`;
            });
        }

        function clearDisplay() {
            [rank1Podium, rank2Podium, rank3Podium, leaderboardList, yourRankContainer].forEach(el => el.innerHTML = '');
        }

        function displayLeaderboard(data, currentPlayerID) {
            clearDisplay();
            let yourData = null;

            data.forEach((player, index) => {
                const rank = index + 1;
                const score = parseFloat(player.officialScore).toFixed(2);
                const timeInSeconds = player.timeInSeconds || 0;
                const minutes = Math.floor(timeInSeconds / 60);
                const seconds = timeInSeconds % 60;
                const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                // Kiểm tra xem đây có phải là người dùng hiện tại không
                if (player.playerID === currentPlayerID) {
                    yourData = { ...player, rank, score, time: formattedTime };
                }

                if (rank === 1) {
                    rank1Podium.innerHTML = `<div class="relative podium-card bg-gradient-to-b from-yellow-300 to-yellow-500 p-4 rounded-t-xl shadow-2xl h-52 flex flex-col justify-center items-center"><svg class="crown-svg" viewBox="0 0 24 24" fill="white"><path d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5zm14 3c0 .55-.45 1-1 1H6c-.55 0-1-.45-1-1v-1h14v1z"></path></svg><div class="w-20 h-20 bg-white rounded-full flex items-center justify-center text-3xl font-bold text-yellow-500 mb-2">${player.playerName.charAt(0)}</div><p class="font-bold text-white truncate w-full">${player.playerName}</p><p class="font-extrabold text-2xl text-white">${score}</p></div>`;
                } else if (rank === 2) {
                    rank2Podium.innerHTML = `<div class="podium-card bg-gradient-to-b from-gray-300 to-gray-400 p-4 rounded-t-xl shadow-lg h-44 flex flex-col justify-center items-center"><div class="w-16 h-16 bg-white rounded-full flex items-center justify-center text-2xl font-bold text-gray-500 mb-2">${player.playerName.charAt(0)}</div><p class="font-bold text-gray-800 truncate w-full">${player.playerName}</p><p class="font-extrabold text-xl text-gray-800">${score}</p></div>`;
                } else if (rank === 3) {
                    rank3Podium.innerHTML = `<div class="podium-card bg-gradient-to-b from-yellow-600 to-yellow-700 p-4 rounded-t-xl shadow-lg h-44 flex flex-col justify-center items-center"><div class="w-16 h-16 bg-white rounded-full flex items-center justify-center text-2xl font-bold text-yellow-700 mb-2">${player.playerName.charAt(0)}</div><p class="font-bold text-white truncate w-full">${player.playerName}</p><p class="font-extrabold text-xl text-white">${score}</p></div>`;
                } else {
                    const playerElement = document.createElement('div');
                    playerElement.className = 'flex items-center bg-gray-50 p-3 rounded-lg hover:bg-gray-100 transition-colors';
                    playerElement.innerHTML = `<p class="w-10 text-lg font-bold text-gray-500">${rank}</p><div class="flex-shrink-0">${createAvatar(player.playerName, "w-10 h-10", "text-base")}</div><p class="flex-grow font-semibold text-gray-800 ml-4">${player.playerName}</p><div class="text-right"><p class="font-bold text-lg text-blue-600">${score}</p><p class="text-sm text-gray-500">${formattedTime}</p></div>`;
                    leaderboardList.appendChild(playerElement);
                }
            });

            if (yourData) {
                yourRankContainer.innerHTML = `<div class="flex items-center bg-blue-100 p-4 rounded-lg border-2 border-blue-500"><p class="w-10 text-lg font-bold text-blue-700">${yourData.rank}</p><div class="flex-shrink-0">${createAvatar(yourData.playerName, "w-10 h-10", "text-base")}</div><p class="flex-grow font-semibold text-blue-800 ml-4">Thành tích của bạn: ${yourData.playerName}</p><div class="text-right"><p class="font-bold text-lg text-blue-700">${yourData.score}</p><p class="text-sm text-gray-600">${yourData.time}</p></div></div>`;
            } else { 
                yourRankContainer.innerHTML = `<p class="text-center text-gray-500">Bạn chưa có trên bảng xếp hạng. Hãy tham gia ngay!</p>`; 
            }
        }

        // Bắt đầu lắng nghe dữ liệu khi trang được tải
        listenToLeaderboard();
    </script>
</body>
</html>